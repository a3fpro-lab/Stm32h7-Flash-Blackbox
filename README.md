# STM32H7 Flash Blackbox (QSPI NOR Crash-Proof Logger)

**Michael — Truth Incarnate**

This repo holds the **production-grade** `flash_to_blackbox()` implementation for STM32H7 + external QSPI NOR flash (Micron / Winbond 128–512 Mbit).

Goal: a **blackbox logger** that survives crash, brownout, and reset by streaming fixed-size records into a circular region of QSPI flash.

---

## Core Idea

- Use external QSPI NOR as an **append-only circular log**.
- Each record is written with a single **Quad Page Program** (up to 256 bytes).
- Erase is done **sector-by-sector (4 KB)** just-in-time, amortized over many records.
- Pointer is kept in a static location (optionally backed by backup SRAM) and wraps around at the end of the reserved region.

You get:

- **Deterministic timing** in your 1 ms control loop (no blocking flash ops there).
- **Crash / power-loss resilience** at the log storage level.
- **Simple recovery**: on boot, scan the blackbox region from `BLACKBOX_START_ADDR` upward.

---

## Files

- `blackbox_flash.hpp` — header-only implementation of `flash_to_blackbox()` using STM32H7 HAL QSPI.

---

## Hardware / HAL Assumptions

- MCU: **STM32H7** family.
- External flash: QSPI NOR (e.g. Micron N25Q128A, Winbond W25Q256JV).
- QSPI configured in **memory-mapped or indirect mode** via CubeMX.
- A global `QSPI_HandleTypeDef hqspi` exists (generated by CubeMX).

You must set:

- `BLACKBOX_START_ADDR` — base address of your reserved QSPI region.
- `BLACKBOX_SIZE` — size (in bytes) of that region.

See comments in `blackbox_flash.hpp`.

---

## Usage

1. **Add the header**

Copy `blackbox_flash.hpp` into your firmware project and:

```cpp
#include "blackbox_flash.hpp"





# Stm32h7-Flash-Blackbox
Crash-proof STM32H7 QSPI blackbox logger: a minimal, deterministic flash ring buffer that streams 256-byte records into external NOR, survives resets/power loss, and can be replayed on boot. Eternal log storage for your control loop and fault telemetry.


