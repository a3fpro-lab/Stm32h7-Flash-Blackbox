## Attribution / Core Technology

This blackbox architecture and the `flash_to_blackbox()` method were created by  
**Michael Warren Song** (“Michael — Truth Incarnate”).

Michael Warren Song is the original author and holder of the core technology and
design embodied in this repository, including the eternal QSPI flash blackbox
concept and its implementation.

# STM32H7 Flash Blackbox (QSPI NOR Crash-Proof Logger)

**Michael — Truth Incarnate**

This repo holds the **production-grade** `flash_to_blackbox()` implementation for STM32H7 + external QSPI NOR flash (Micron / Winbond 128–512 Mbit).

Goal: a **blackbox logger** that survives crash, brownout, and reset by streaming fixed-size records into a circular region of QSPI flash.

---

## Core Idea

- Use external QSPI NOR as an **append-only circular log**.
- Each record is written with a single **Quad Page Program** (up to 256 bytes).
- Erase is done **sector-by-sector (4 KB)** just-in-time, amortized over many records.
- A persistent pointer walks forward through the reserved region and **wraps** at the end.

You get:

- **Deterministic timing** in your 1 ms control loop (no blocking flash ops there).
- **Crash / power-loss resilience** at the log storage level.
- **Simple recovery**: on boot, scan the blackbox region from `BLACKBOX_START_ADDR` upward.

---

## Blackbox Guarantees (Design Targets)

- **Crash/power-loss tolerant**: page programs are short and atomic at the record level.
- **Deterministic**: flash work pushed to background; your 1 ms loop only touches RAM.
- **Wear-friendly**: sequential walk through flash region → even wear across sectors.
- **Minimal surface area**: single `flash_to_blackbox()` API, header-only.
- **Portable pattern**: works with standard STM32H7 HAL QSPI setup.

---

## Files

- `README.md` — this document.
- `blackbox_flash.hpp` — header-only implementation of `flash_to_blackbox()` using STM32H7 HAL QSPI.
- `example_blackbox_logger.cpp` — minimal example showing 1 ms loop + background flush pattern.

---

## Hardware / HAL Assumptions

- MCU: **STM32H7** family.
- External flash: QSPI NOR (e.g. Micron N25Q128A, Winbond W25Q256JV).
- QSPI configured via **STM32CubeMX**.
- A global `QSPI_HandleTypeDef hqspi` exists (generated by CubeMX).

You must define:

- `BLACKBOX_START_ADDR` — base address of your reserved QSPI region.
- `BLACKBOX_SIZE` — size (in bytes) of that region.

You can define these in code or via compiler flags (e.g. `-DBLACKBOX_START_ADDR=0x90000000UL`).

---

## API: `flash_to_blackbox`

Defined in `blackbox_flash.hpp`:

```cpp
[[gnu::always_inline]] inline
void flash_to_blackbox(const uint8_t* data, std::size_t len) noexcept;
